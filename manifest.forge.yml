modules:
  # ============================================
  # FORGE CUSTOM UI - PR SIDEBAR
  # ============================================
  
  # Static resources (React build output)
  forge:resource:
    - key: risk-radar-ui-resources
      path: frontend/build
  
  # ============================================
  # BRIDGE FUNCTIONS
  # ============================================
  
  function:
    # Get risk analysis for PR
    - key: get-risk-analysis-fn
      handler: bridge.getRiskAnalysis.handler
      
    # Create Jira task
    - key: create-jira-task-fn
      handler: bridge.createJiraTask.handler
      
    # Post PR comment
    - key: post-pr-comment-fn
      handler: bridge.postPRComment.handler
      
    # Get similar incidents
    - key: get-similar-incidents-fn
      handler: bridge.getSimilarIncidents.handler
      
    # Refresh analysis
    - key: refresh-analysis-fn
      handler: bridge.getRiskAnalysis.handler

  # ============================================
  # BITBUCKET PR SIDEBAR
  # ============================================
  
  bitbucket:pullRequestSidebar:
    - key: risk-radar-sidebar
      resource: risk-radar-ui-resources
      title: Code Risk Radar
      render: native
      resolver:
        function: get-risk-analysis-fn

  # ============================================
  # GITHUB PR PANEL (Alternative)
  # ============================================
  
  # github:pullRequestPanel:
  #   - key: risk-radar-panel
  #     resource: risk-radar-ui-resources
  #     title: Code Risk Radar
  #     render: native
  #     resolver:
  #       function: get-risk-analysis-fn

  # ============================================
  # ROVO AGENTS
  # ============================================
  
  rovo:agent:
    # Risk Analyst Agent
    - key: risk-analyst-agent
      name: Risk Analyst
      description: Analyzes code changes for security, performance, and maintainability risks
      prompt:
        - text: |
            You are an expert code security and quality analyst. Your role is to analyze code changes
            in pull requests and identify potential risks across multiple dimensions:
            
            1. **Security**: SQL injection, XSS, authentication bypasses, sensitive data exposure
            2. **Performance**: N+1 queries, memory leaks, inefficient algorithms
            3. **Maintainability**: Code complexity, technical debt, poor practices
            4. **Reliability**: Error handling gaps, race conditions, edge cases
            
            For each code change provided, you must:
            
            **Step 1: Feature Extraction**
            Identify key risk indicators:
            - SQL keywords and query patterns
            - User input handling
            - Authentication/authorization logic
            - External API calls
            - Database operations
            - File system access
            - Regular expressions
            - Cryptographic operations
            
            **Step 2: Risk Scoring**
            Assign a risk score from 0.0 (safe) to 1.0 (critical) based on:
            - Severity of potential vulnerabilities
            - Likelihood of exploitation
            - Impact on system security/stability
            - Complexity of the change
            
            **Step 3: Risk Classification**
            Classify as: critical (0.8+), high (0.6-0.79), medium (0.4-0.59), low (0-0.39)
            
            **Step 4: Actionable Recommendations**
            Provide specific, actionable recommendations with:
            - Clear description of the issue
            - Priority level (critical, high, medium, low)
            - Evidence (specific code lines)
            - Estimated effort to fix
            - Confidence level (0.0-1.0)
            
            **Output Format (JSON):**
            ```json
            {
              "risk_score": 0.85,
              "risk_level": "critical",
              "explanation": "Brief explanation of the primary risk",
              "actions": [
                {
                  "type": "security|performance|maintainability|reliability",
                  "priority": "critical|high|medium|low",
                  "description": "Clear action to take",
                  "evidence_lines": ["code snippet 1", "code snippet 2"],
                  "effort_estimate": "30 minutes",
                  "confidence": 0.95
                }
              ],
              "top_features": [
                {"name": "feature_name", "importance": 0.45}
              ]
            }
            ```
            
            Be thorough but concise. Focus on actionable insights, not generic advice.
            
      actions:
        - key: create-jira-task-action
        - key: post-pr-comment-action
    
    # Historian Agent
    - key: historian-agent
      name: Code Historian
      description: Searches historical incidents and patterns to provide context for current risks
      prompt:
        - text: |
            You are a knowledge retrieval specialist focused on code security and quality incidents.
            Your role is to search historical incident data and provide relevant context for current
            code risks.
            
            When analyzing a code change, you will:
            
            **Step 1: Embedding-Based Search**
            Use semantic similarity to find past incidents related to:
            - Similar code patterns
            - Same vulnerability types
            - Related technologies/frameworks
            - Comparable risk levels
            
            **Step 2: Context Enrichment**
            For each similar incident, provide:
            - Incident ID and summary
            - Similarity score (0.0-1.0)
            - How it was resolved
            - Lessons learned
            - Links to tickets/documentation
            
            **Step 3: Pattern Identification**
            Identify recurring patterns across incidents:
            - Common root causes
            - Frequently vulnerable code areas
            - Team-specific anti-patterns
            
            **Step 4: Recommendations**
            Suggest preventive measures:
            - Process improvements
            - Tooling additions
            - Training needs
            
            **Output Format (JSON):**
            ```json
            {
              "similar_incidents": [
                {
                  "id": "INC-2023-045",
                  "summary": "Brief description",
                  "similarity": 0.92,
                  "resolution": "How it was fixed",
                  "link": "https://jira.company.com/browse/INC-2023-045",
                  "lessons": ["Lesson 1", "Lesson 2"],
                  "severity": "critical|high|medium|low",
                  "occurred_at": "2023-08-15T10:30:00Z"
                }
              ],
              "patterns": [
                "Pattern description 1",
                "Pattern description 2"
              ],
              "recommendations": [
                "Recommendation 1",
                "Recommendation 2"
              ]
            }
            ```
            
            Prioritize the most relevant and recent incidents. Limit to top 5 matches.

  # ============================================
  # ROVO ACTIONS
  # ============================================
  
  rovo:action:
    # Create Jira Task
    - key: create-jira-task-action
      name: Create Jira Task
      description: Creates a Jira task for addressing identified code risks
      function: create-jira-task-fn
      parameters:
        - name: risk_analysis
          description: Risk analysis data from the Risk Analyst agent
          type: object
          required: true
        - name: confirm
          description: Whether to actually create the task (true) or just preview (false)
          type: boolean
          required: false
          default: false
    
    # Post PR Comment
    - key: post-pr-comment-action
      name: Post PR Comment
      description: Posts risk analysis as a comment on the pull request
      function: post-pr-comment-fn
      parameters:
        - name: risk_analysis
          description: Risk analysis data from the Risk Analyst agent
          type: object
          required: true
        - name: confirm
          description: Whether to actually post the comment (true) or just preview (false)
          type: boolean
          required: false
          default: false

  # ============================================
  # PERMISSIONS
  # ============================================

permissions:
  scopes:
    # Storage for caching
    - storage:app
    
    # Jira access
    - read:jira-work
    - write:jira-work
    
    # Bitbucket access
    - read:repository:bitbucket
    - read:pullrequest:bitbucket
    - write:pullrequest:bitbucket
    
    # GitHub access (if using GitHub)
    # - read:repository:github
    # - read:pullrequest:github
    # - write:pullrequest:github
    
    # External fetch for GitHub API
    - external:fetch

  # External domains for API calls
  external:
    fetch:
      backend:
        - '*.github.com'
        - 'api.github.com'
        - '*.supabase.co'  # If using Supabase for embeddings

# ============================================
# APP METADATA
# ============================================

app:
  id: ari:cloud:ecosystem::app/YOUR_APP_ID
  name: Code Risk Radar
  description: AI-powered code risk analysis for pull requests with Atlassian Rovo
  version: 1.0.0
  
  runtime:
    name: nodejs18.x
  
  connect:
    key: code-risk-radar
    name: Code Risk Radar
    description: Analyze code risks in pull requests
    vendor:
      name: Your Company
      url: https://your-company.com
